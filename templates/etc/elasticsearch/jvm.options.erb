# This file is managed by Puppet -- <%= @name %>
#
# Set the 'jvm_options' parameter on the elasticsearch class to change this file.
<%
def set_default(options, match_string, default)
  options.detect {|o| o.include?(match_string)} || options.push(default)
end

defaults = {
  '-Xms' => '-Xms1g',
  '-Xmx' => '-Xmx1g',
  'UseConcMarkSweepGC' => '8-14:-XX:+UseConcMarkSweepGC',
  'CMSInitiatingOccupancyFraction=' => '8-14:-XX:CMSInitiatingOccupancyFraction=75',
  'UseCMSInitiatingOccupancyOnly' => '8-14:-XX:+UseCMSInitiatingOccupancyOnly',
  '-Des.networkaddress.cache.ttl' => '-Des.networkaddress.cache.ttl=60',
  '-Des.networkaddress.cache.negative.ttl' => '-Des.networkaddress.cache.negative.ttl=10',
  'AlwaysPreTouch' => '-XX:+AlwaysPreTouch',
  'server' => '-server',
  '-Xss' => '-Xss1m',
  '-Djava.awt.headless=' => '-Djava.awt.headless=true',
  '-Dfile.encoding=' => '-Dfile.encoding=UTF-8',
  '-Djna.nosys=' => '-Djna.nosys=true',
  'OmitStackTraceInFastThrow' => '-XX:-OmitStackTraceInFastThrow',
  '-Dio.netty.noUnsafe' => '-Dio.netty.noUnsafe=true',
  '-Dio.netty.noKeySetOptimization' => '-Dio.netty.noKeySetOptimization=true',
  '-Dio.netty.recycler.maxCapacityPerThread' => '-Dio.netty.recycler.maxCapacityPerThread=0',
  '-Dlog4j.shutdownHookEnabled' => '-Dlog4j.shutdownHookEnabled=false',
  '-Dlog4j2.disable.jmx' => '-Dlog4j2.disable.jmx=true',
  '-Djava.io.tmpdir' => '-Djava.io.tmpdir=${ES_TMPDIR}',
  'HeapDumpOnOutOfMemoryError' => '-XX:+HeapDumpOnOutOfMemoryError',
  'HeapDumpPath' => "-XX:HeapDumpPath=#{@instance_datadir}",
  'ErrorFile' => "-XX:ErrorFile=#{@logdir}/hs_err_pid%p.log",
  'PrintGCDetails' => '8:-XX:+PrintGCDetails',
  'PrintGCDateStamps' => '8:-XX:+PrintGCDateStamps',
  'PrintTenuringDistribution' => '8:-XX:+PrintTenuringDistribution',
  'Xloggc' => "8:-Xloggc:#{@logdir}/gc.log",
  'UseGCLogFileRotation' => '8:-XX:+UseGCLogFileRotation',
  'NumberOfGCLogFiles' => '8:-XX:NumberOfGCLogFiles=32',
  'GCLogFileSize' => '8:-XX:GCLogFileSize=64m',
  # JDK 9+ GC logging
  'Xlog:gc' => "9-:-Xlog:gc*,gc+age=trace,safepoint:file=#{@logdir}/gc.log:utctime,pid,tags:filecount=32,filesize=64m",
  # due to internationalization enhancements in JDK 9 Elasticsearch need to set the provider to COMPAT otherwise
  # time/date parsing will break in an incompatible way for some date patterns and locals
  '-Djava.locale.providers' => '9-:-Djava.locale.providers=COMPAT',
}
defaults.each {|k,v| set_default(@jvm_options, k, v)}

-%>

<% @jvm_options.sort.each do |line| -%>
<%= line %>
<% end -%>
